name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Get version name
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            app/build/outputs/apk/release/*.apk
          name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## Changes in this Release

            See [CHANGELOG.md](https://github.com/willbeeching/flix/blob/master/CHANGELOG.md) for full details.

            ## Installation

            1. Download the APK below
            2. Transfer it to your Android TV device
            3. Enable "Install from Unknown Sources" in Settings
            4. Install the APK
            5. Follow the in-app setup guide

            ## First-Time Setup

            1. Open Flix and click "Connect to Plex"
            2. Scan the QR code with your phone
            3. Authorize the app in your browser
            4. Select your Plex server and libraries
            5. (Optional) Configure API keys for enhanced artwork in API Settings

            ## Support

            Report issues: https://github.com/willbeeching/flix/issues
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
